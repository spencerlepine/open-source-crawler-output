name: Archive Report ğŸ—‘

on:
  workflow_dispatch:
    inputs:
      repo_user:
        type: string
        description: <github_username>
        required: true
      repo_name:
        type: string
        description: <github_repository>
        required: true

jobs:
  input_check:
    name: "ğŸš§ Validate Action Inputs"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸš§ Test [repo_user] input with regex"
        uses: actions-ecosystem/action-regex-match@v2
        id: user-regex-check
        with:
          text: ${{ github.event.inputs.repo_user }}
          regex: '[\w,\-]'

      - name: "ğŸš« Deny invalid snippet [repo_name] input"
        if: ${{ steps.user-regex-check.outputs.match == '' }}
        run: |
          echo "Invalid user folder path"
          exit 1
          
      - name: "ğŸš§ Test [repo_name] input with regex"
        uses: actions-ecosystem/action-regex-match@v2
        id: name-regex-check
        with:
          text: ${{ github.event.inputs.repo_name }}
          regex: '[\w,\-,\_]'

      - name: "ğŸš« Deny invalid snippet [repo_name] input"
        if: ${{ steps.name-regex-check.outputs.match == '' }}
        run: |
          echo "Invalid repo name folder path"
          exit 1

      - name: "â˜ï¸ Check out Git Repository"
        uses: actions/checkout@v2

      - name: "ğŸš§ Verify snippet exists in snippets folder"
        run: |
          test -d ./${{ github.event.inputs.repo_user }}/${{ github.event.inputs.repo_name }}/ && echo "âœ… Folder exists" || (echo âŒ Folder not found && exit 1)

  folder_delete:
    needs: [input_check]
    name: "ğŸ—‘ï¸ Archive Report"
    runs-on: ubuntu-latest

    steps:
      - name: "â˜ï¸ Check out Git Repository"
        uses: actions/checkout@v3

      - name: "ğŸš— Move to archive folder"
        run: |
          mkdir -p .archive
          mkdir -p ./.archive/${{ github.event.inputs.repo_user }}/${{ github.event.inputs.repo_name }}
          cp -a ./${{ github.event.inputs.repo_user }}/${{ github.event.inputs.repo_name }}/. ./.archive/${{ github.event.inputs.repo_user }}/${{ github.event.inputs.repo_name }}

      - name: "âŒ Delete the original folder"
        run: |
          rm -rf ./${{ github.event.inputs.repo_user }}/${{ github.event.inputs.repo_name }}

      - name: "ğŸš€ Commit [${{ github.event.inputs.repo_name }}] archive"
        run: |
          git config pull.rebase false
          git pull
          git add .
          git config --global user.name "SpencerBot"
          git config --global user.email "spencerbot@example.com"
          git commit -m "âŒ [Automated] Archived report folder (${{ github.event.inputs.repo_user }}/${{ github.event.inputs.repo_name }})"

      - name: "ğŸš€ Push changes to repo"
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
